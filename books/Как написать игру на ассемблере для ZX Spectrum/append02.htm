<HTML>
<HEAD>
 <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=windows-1251">
 <META NAME="Author" CONTENT="Alex">
 <META NAME="GENERATOR" CONTENT="Mozilla/4.04 [en] (Win95; I) [Netscape]">
 <META NAME="KEYWORDS" CONTENT="zx, spectrum, speccy, sinclair, z80, assembler">
 <TITLE>Как написать игру для ZX Spectrum на ассемблере - Приложение II</TITLE>
</HEAD>

<BODY TEXT="#000000" BGCOLOR="#FFFFFF" LINK="#0000FF" VLINK="#FF0000" ALINK="#000066">

<BASEFONT SIZE=3>

<h2><a name="n00">ПРИЛОЖЕНИЕ II</a></h2>
<hr>
<h3>НЕКОТОРЫЕ НЕДОКУМЕНТИРОВАННЫЕ КОМАНДЫ</h3>
К&nbsp;недокументированным относятся те команды, которые не были описаны фирмой-разработчиком микропроцессора Z80A&nbsp;CPU. Вполне возможно, они даже не были запланированы, а получились, если так можно выразиться, как издержки производства. В&nbsp;связи с этим каждый программист &laquo;открывает&raquo; их для себя, пользуясь методом &laquo;научного тыка&raquo;. Вы также можете поэкспериментировать, используя некоторые правила построения системы команд, о которой мы и хотим здесь рассказать.
Внимательно изучив коды, приведенные в предыдущем приложении, вы сможете заметить определенную закономерность. Сравните, например, команды LD&nbsp;HL,NN, LD&nbsp;IX,NN и LD&nbsp;IY,NN. Не правда ли, кодировки очень похожи друг на друга? Команды, использующие индексные регистры, состоят из тех же кодов, что и LD&nbsp;HL,NN, но предваряются специальным префиксом #DD для IX или #FD для&nbsp;IY.
Среди &laquo;стандартных&raquo; мнемоник отсутствуют команды обработки половинок индексных регистров, но воспользовавшись правилами кодировки, не трудно получить такие команды. Они будут соответствовать кодам обработки регистров&nbsp;H и&nbsp;L, перед которыми стоит один из указанных выше префиксов. Например, для загрузки младшей половинки регистра&nbsp;IX числом&nbsp;32 можно написать следующую последовательность:
<pre>
       DEFB  #DD
       LD    L,32
</pre>
В мнемоническом обозначении такая команда обычно записывается как LD&nbsp;IXL,32. С&nbsp;префиксами #DD и #FD аналогичным образом могут быть получены следующие команды:
<pre>
       ADD   A,s
       ADC   A,s
       AND   s
       CP    s
       DEC   s
       INC   s
       LD    r,s
       LD    s,n
       LD    s,r
       OR    s
       SBC   A,s
       SUB   s
       XOR   s
</pre>
где <b>s</b>&nbsp;- IXH, IXL, IYH или IYL; <b>r</b>&nbsp;- A, B, C, D или E; <b>n</b>&nbsp;- однобайтовое числовое значение.
Существует еще целый ряд интересных команд, получаемых с префиксами #DD и #FD, которые могут выполнять сразу два действия&nbsp;- устанавливать или сбрасывать биты одновременно в регистре и в памяти, адресуемой индексными регистрами. Например, команда
<pre>
       SET   1,A(IX+3)
</pre>
сначала установит бит 1 в ячейке, адресуемой IX со смещением в 3&nbsp;байта, а затем поместит полученное значение в регистр&nbsp;A. То есть выполняются как бы две команды:
<pre>
       SET   1,(IX+3)
       LD    A,(IX+3)
</pre>
Приведем способы кодировки некоторых команд этой группы, а остальные предлагаем вам составить самостоятельно по аналогии с приведенными. Описанная выше команда получается из стандартной
<pre>
       SET   1,A
</pre>
Эта команда кодируется двумя байтами #CB и #CF (см.&nbsp;<a href="append01.htm#n00" target="view">Приложение&nbsp;I</a>). Для получения новой команды необходимо вначале поставить код префикса, а между байтами исходной команды вставить байт величины смещения. Таким образом, приведенная выше мнемоника должна кодироваться последовательностью #DD, #CB, #03, #CF.
Команда
<pre>
       RES   5,H(IY-5)
</pre>
получается, исходя из кодировки команды
<pre>
       RES   5,H
</pre>
В результате у вас должна получиться последовательность кодов #FD, #CB, #FB, #AC.
Конечно, все предложенные мнемоники не поддерживаются ассемблером GENS, поэтому использовать их можно одним лишь способом&nbsp;- записывая коды непосредственно в директиве DEFB. То есть последняя команда в ассемблерном тексте будет выглядеть так:
<pre>
       DEFB  #FD,#CB,#FB,#AC
</pre>
Несколько сложнее дела обстоят с другими префиксами: #CB и #ED. С&nbsp;ними также можно получить ряд новых команд, хотя часто они лишь повторяют &laquo;стандартные&raquo; инструкции (особенно это относится к префиксу #ED) и практической пользы поэтому от них мало. Такие команды чаще используются для защиты коммерческих программ, чтобы текст невозможно было прочитать (ни один из известных дизассемблеров недокументированные команды не распознает).
Для поисков лучше всего использовать отладчик MONS, так как он в режиме трассировки тупо выполняет машинные инструкции, совершенно не вникая в их смысл. Но в данном случае вам это как раз и нужно. Любой код, который вы ему подсунете, будет выполнен абсолютно так же, как и в программе (заметим, что другой трассировщик&nbsp;- Mon2&nbsp;- перед выполнением очередной команды справляется о ней в таблице, поэтому, если вы решите использовать для экспериментов именно этот дизассемблер, стоит оформлять искомые коды в виде подпрограммы и трассировать их, нажимая клавишу <b>S</b>).
Поскольку &laquo;пропущенных&raquo; команд, получаемых с использованием префикса #CB немного, приведем их полный список (кстати, дизассемблер Mon2, в отличие от MONS, прекрасно &laquo;справляется&raquo; с этой группой команд).
<pre>
       SLL   (HL)        ; CB36
       SLL   (IX+Д)      ; DDCBXX36
       SLL   (IY+Д)      ; FDCBXX36
       SLL   A           ; CB37
       SLL   B           ; CB30
       SLL   C           ; CB31
       SLL   D           ; CB32
       SLL   E           ; CB33
       SLL   H           ; CB34
       SLL   L           ; CB35
</pre>
Эти команды дополняют перечень команд сдвига. При их выполнении содержимое регистра или ячейки памяти сдвигается влево на один разряд. Старший бит переходит во флаг CY, а младший в любом случае заполняется единицей. Например, после сдвига числа 00101110 командой SLL (в&nbsp;такой мнемонике данные команды показываются дизассемблером Mon2, однако в литературе часто предлагается другое обозначение - SLI; тем не менее, это те же самые команды) получится значение 01011101. Команда воздействует на флаги CY, Z, P/V и&nbsp;S. Флаги&nbsp;H и&nbsp;N сбрасываются в&nbsp;0.
Если вы решите использовать в своей программе приведенные выше инструкции, то помните, что ассемблер GENS понятия не имеет о существовании мнемоники SLL. Поэтому все команды придется кодировать исключительно с помощью директивы DEFB.

<hr>

<center><table border=0 cellpadding=24>
<tr><td>
<a href="append01.htm#n00"><img src="prev.gif" border=0 hspace=8>Приложение I</a></td>
<a href="liter.htm#n00">Литература<img src="next.gif" border=0 hspace=8></a>
</td></tr>
</table></center>
<center><a href="wgasmtoc.htm#n00">Оглавление</a></center>

<hr>

</BODY>
</HTML>
